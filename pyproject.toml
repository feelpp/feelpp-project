#!/bin/bash

set -euo pipefail

if [[ $# -lt 1 ]]; then
  cat <<EOF
Usage: $0 <version> [<extra>]
  version  X.Y.Z       (e.g. 4.5.0)
  extra    -rc.1       (optional suffix)
EOF
  exit 1
fi

VERSION=$1
EXTRA="${2:-}"              # e.g. "-rc.1" or empty
TAG="v${VERSION}${EXTRA}"

echo "ðŸ”– Releasing ${TAG} â€¦"

# 1) bump CMake project version
sed -E -i.bak \
  -e "s#(project\(\s*feelpp-project\s+VERSION\s+)[0-9]+\.[0-9]+\.[0-9]+#\1${VERSION}#i" \
  CMakeLists.txt
rm CMakeLists.txt.bak

# 2) bump CMake EXTRA_VERSION
sed -E -i.bak \
  -e "s#(set\s*\(\s*EXTRA_VERSION\s*\")[^\"]*(\"\))#\1${EXTRA}\2#i" \
  CMakeLists.txt
rm CMakeLists.txt.bak

# 3) bump package.json (with suffix)
sed -E -i.bak \
  -e "s#(\"version\"[[:space:]]*:[[:space:]]*\")[^\"]*(\")#\1${VERSION}${EXTRA}\2#i" \
  package.json
rm package.json.bak

# 4) bump pyproject.toml (with suffix)
sed -E -i.bak \
  -e "s#(^[[:space:]]*version[[:space:]]*=[[:space:]]*\")[^\"]*(\")#\1${VERSION}${EXTRA}\2#i" \
  pyproject.toml
rm pyproject.toml.bak

# 5) commit, tag & push
git add CMakeLists.txt package.json pyproject.toml
git commit -m "Release ${TAG}"
git tag "${TAG}"
git push origin HEAD --follow-tags

echo "âœ… Successfully released ${TAG}"